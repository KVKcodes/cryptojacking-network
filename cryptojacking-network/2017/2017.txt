On Friday, May 12, attackers spread a massive ransomware attack worldwide using the EternalBlue exploit to rapidly propagate the malware over corporate LANs and wireless networks. EternalBlue, originally exposed on April 14 as part of the Shadow Brokers dump of NSA hacking tools, leverages a vulnerability (MS17-010) in Microsoft Server Message Block (SMB) on TCP port 445 to discover vulnerable computers on a network and laterally spread malicious payloads of the attacker’s choice. This particular attack also appeared to use an NSA backdoor called DoublePulsar to actually install the ransomware known as WannaCry.

Over the subsequent weekend, however, we discovered another very large-scale attack using both EternalBlue and DoublePulsar to install the cryptocurrency miner Adylkuzz. Initial statistics suggest that this attack may be larger in scale than WannaCry: because this attack shuts down SMB networking to prevent further infections with other malware (including the WannaCry worm) via that same vulnerability, it may have in fact limited the spread of last week’s WannaCry infection.

Symptoms of this attack include loss of access to shared Windows resources and degradation of PC and server performance. Several large organizations reported network issues this morning that were originally attributed to the WannaCry campaign. However, because of the lack of ransom notices, we now believe that these problems might be associated with Adylkuzz activity. However, it should be noted that the Adylkuzz campaign significantly predates the WannaCry attack, beginning at least on May 2 and possibly as early as April 24. This attack is ongoing and, while less flashy than WannaCry, is nonetheless quite large and potentially quite disruptive.

The Discovery

In the course of researching the WannaCry campaign, we exposed a lab machine vulnerable to the EternalBlue attack. While we expected to see WannaCry, the lab machine was actually infected with an unexpected and less noisy guest: the cryptocurrency miner Adylkuzz. We repeated the operation several times with the same result: within 20 minutes of exposing a vulnerable machine to the open web, it was enrolled in an Adylkuzz mining botnet.

EternalBlue/DoublePulsar attack from one of several identified hosts

Figure 1: EternalBlue/DoublePulsar attack from one of several identified hosts, then Adylkuzz being download from another host - A hash of a pcap of this capture is available in the IOCs table

The attack is launched from several virtual private servers which are massively scanning the Internet on TCP port 445 for potential targets.

Upon successful exploitation via EternalBlue, machines are infected with DoublePulsar. The DoublePulsar backdoor then downloads and runs Adylkuzz from another host. Once running, Adylkuzz will first stop any potential instances of itself already running and block SMB communication to avoid further infection. It then determines the public IP address of the victim and download the mining instructions, cryptominer, and cleanup tools.

It appears that at any given time there are multiple Adylkuzz command and control (C&C) servers hosting the cryptominer binaries and mining instructions. 

Figure 2 shows the post-infection traffic generated by Adylkuzz in this attack.

Post-infection traffic associated with the attack

Figure 2: Post-infection traffic associated with the attack

In this attack, Adylkuzz is being used to mine Monero cryptocurrency. Similar to Bitcoin but with enhanced anonymity capabilities, Monero recently saw a surge in activity after it was adopted by the AlphaBay darknet market, described by law enforcement authorities as “a major underground website known to sell drugs, stolen credit cards and counterfeit items.” Like other cryptocurrencies, Monero increases market capitalization through the process of mining. This process is computationally intensive but rewards miners with funds in the mined currency, currently 7.58 Moneros or roughly $205 at current exchange rates.

Figure 3 shows Adylkuzz mining Monero cryptocurrency, a process that can be more easily distributed across a botnet like that created here than in the case of Bitcoin, which now generally requires dedicated, high-performance machines.

Adylkuzz mining Monero cryptocurrency

Figure 3: Part of the behavioral analysis from an Adylkuzz-infected VM showing it, among other things, closing SMB door and launching Monero Mining

One of several Monero addresses associated with this attack is shown in Figure 4. The hash rate shows the relative speed with which the specific associated instance of the botnet is mining Moneros, while the total paid shows the amount paid to this particular address for mining activities. In this case, just over $22,000 was paid out before the mining associated with this address ceased.

One of several Monero addresses associated with income from Adylkuzz mining

Figure 4: One of several Monero addresses associated with income from Adylkuzz mining

Looking at the mining payments per day associated with a single Adylkuzz address, we can see the increased payment activity beginning on April 24 when this attack began. We believe that the sudden drop that occurred on May 11 indicates when the actors switched to a new mining user address (Figure 5). By regularly switching addresses, we believe that the actors are attempting to avoid having too many Moneros paid to a single address.

Daily payment activity associated with a single Adylkuzz mining address

Figure 5: Daily payment activity associated with a single Adylkuzz mining address

Statistics and payment history for a second payment address are shown in Figure 6. This address has had just over $7,000 paid to date.

A second Monero address associated with income from Adylkuzz mining

Figure 6: A second Monero address associated with income from Adylkuzz mining

A third address shows a higher hash rate and a current payment total of over $14,000 (Figure 7).

A third Monero address associated with income from Adylkuzz mining

Figure 7: A third Monero address associated with income from Adylkuzz mining

We have currently identified over 20 hosts setup to scan and attack, and are aware of more than a dozen active Adylkuzz C&C servers. We also expect that there are many more Monero mining payment addresses and Adylkuzz C&C servers associated with this activity.

Conclusion

Like last week’s WannaCry campaign, this attack makes use of leaked NSA hacking tools and leverages a patched vulnerability in Microsoft Windows networking. The Adylkuzz campaign, in fact predates WannaCry by many days. For organizations running legacy versions of Windows or who have not implemented the SMB patch that Microsoft released last month, PCs and servers will remain vulnerable to this type of attack. Whether they involve ransomware, cryptocurrency miners, or any other type of malware, these attacks are potentially quite disruptive and costly. Two major campaigns have now employed the attack tools and vulnerability; we expect others will follow and recommend that organizations and individuals patch their machines as soon as possible.

Acknowledgments

We want to thank:

Our friends at Trend Micro for input allowing us to add more IOCs
Cloudflare and Choopa for their immediate action upon notification.
@benkow_ for several inputs.

=============================

On Friday, May 12, attackers spread a massive ransomware attack worldwide using the EternalBlue exploit to rapidly propagate the malware over corporate LANs and wireless networks. EternalBlue, originally exposed on April 14 as part of the Shadow Brokers dump of NSA hacking tools, leverages a vulnerability (MS17-010) in Microsoft Server Message Block (SMB) on TCP port 445 to discover vulnerable computers on a network and laterally spread malicious payloads of the attacker’s choice. This particular attack also appeared to use an NSA backdoor called DoublePulsar to actually install the ransomware known as WannaCry.

Over the subsequent weekend, however, we discovered another very large-scale attack using both EternalBlue and DoublePulsar to install the cryptocurrency miner Adylkuzz. Initial statistics suggest that this attack may be larger in scale than WannaCry: because this attack shuts down SMB networking to prevent further infections with other malware (including the WannaCry worm) via that same vulnerability, it may have in fact limited the spread of last week’s WannaCry infection.

Symptoms of this attack include loss of access to shared Windows resources and degradation of PC and server performance. Several large organizations reported network issues this morning that were originally attributed to the WannaCry campaign. However, because of the lack of ransom notices, we now believe that these problems might be associated with Adylkuzz activity. However, it should be noted that the Adylkuzz campaign significantly predates the WannaCry attack, beginning at least on May 2 and possibly as early as April 24. This attack is ongoing and, while less flashy than WannaCry, is nonetheless quite large and potentially quite disruptive.
================

It has been reported that a new cryptocurrency miner ransomware named as "Adylkuzz" is spreading, exploiting Microsoft Server Message Block (SMB) vulnerability (MS17-010). Adylkuzz also uses exploits ETERNALBLUE for exploiting the SMB vulnerability & install DOUBLEPULSAR backdoor, the same exploits used by WannaCry ransomware. It propagates by scanning internet for machines with open TCP 445 port, if found then it uses ETERNALBLUE exploit for initial exploitation and thereafter infect machines with DOUBLEPULSAR backdoor.

The malware is capable of performing the following functions:

It mines Monero, a cryptocurrency similar to BitcoinIt shut down SMB networking to prevent further infections with other malware (including the WannaCry worm) by blocking TCP port 445 in windows FirewallIt degrades PC and server performancesIt prevents access to shared Windows resourcesIt make network connections to C2 server and sends Public IP address, Malware version, operating system and architecture, CPU frequency, Number of processors & Memory size information of infected machineIt determines the public IP address of the victim, downloads Monero cryptocurrency miner and additional tools, and make DNS queries to the Monero mining pool server.Downloads the mining instructions
Indicators of Compromise:

File system changes:

It creates the following files:

%ProgramFiles%\Hardware Driver Management \ windriver.exe%Windir%\Fonts \ wuauser.exe%ProgramFiles%\Microsoft.NET\Primary Interop Assemblies \ LMS.dat%Windir%\Fonts \ msiexev.exe%Temp%\[RANDOM CHARACTERS]._Miner_.log
Services created with service name:

WHDMIDEWELM
The Trojan stops itself and the miner process if the following processes are running:

taskmgr.exemmc.exeprocexp.exe
It detects the presence of antivirus installed on affected machine by checking the following processes:

avp.exe, nod32krn.exe, mcshield.exe, ccsvchst.exe, 360sd.exe, avguard.exe, msseces.exe, avastsvc.exe, avgnsx.exe, spidernt.exe, kwatch.exe, xcomsvr.exe, fsdfwd.exe, ravmon.exe, sfctlcom.exe, qhlpsvc.exe, guardxservice.exe

List of SHA256 of Adylkuzz samples:

29d6f9f06fa780b7a56cae0aa888961b8bdc559500421f3bb3b97f3dd94797c28200755cbedd6f15eecd8207eba534709a01957b172d7a051b9cc4769ddbf233450cb5593d2431d00455cabfecc4d28d42585789d84c25d25cdc5505189b4f9fa7000b2618512f1cb24b51f4ae2f34d332b746183dfad6483aba04571ba8b2f9e96681456d793368a6fccfa1321c10c593f3527d7cadb1ff462aa0359af61deee6680bf0d3b32583047e9304d1703c87878c7c82910fbe05efc8519d2ca2df7155622d4a582ceed0d54b12eb40222bca9650cc67b39f74c5f4b78320a036af886f74f7c01503913553b0a6118b0ea198c5a419be86fca4aaae275663806f68f3fab31a2d44e38e733e1002286e5df164509afe18149a8a2f527ec6dc5e71cb00d73c9230811f1075d5697679b6007f5c15a90177991e238c5adc3ed55ce04988
Network communications:

Connects to below mentioned Command & Control (C2) servers to report installation:

panel.minecoins18[.]com/install/st******08.super5566[.]com/install/st******am.super1024[.]com/report/st******
Connects to URLs used for downloading the cpuminer cryptocurrency miner:

panel.minecoins18[.]com/x64******panel.minecoins18[.]com/x86******08.super5566[.]com/64.******08.super5566[.]com/86.******am.super1024[.]com/64.******am.super1024[.]com/86.******
Connects to URLs to download configuration for cpuminer:

panel.minecoins18[.]com/argline******08.super5566[.]com/mine******am.super1024[.]com/mine******
Connects to below mentioned domains to sends the information and may download updates:

panel.minecoins18[.]com08.super5566[.]comam.super1024[.]com
It is advised to block/monitor the connections to the above mentioned C2 domains.

Note: For complete list of indicators of compromise, kindly refer to the references section.


Specific Countermeasures to prevent Adylkuzz infection:
Users and administrators are advised to take the following preventive measures to protect their computer networks from ransomware infection/ attacks:

In order to prevent infection users and organizations are advised to apply patches to Windows systems as mentioned in Microsoft Security Bulletin MS17-010
Microsoft Patch for Unsupported Versions such as Windows XP,Vista,Server 2003, Server 2008 etc. http://www.catalog.update.microsoft.com/Search.aspx?q=KB4012598
To prevent data loss Users & Organisations are advised to take backup of Critical Data
Block SMB ports on Enterprise Edge/perimeter network devices [UDP 137, 138 and TCP 139, 445] or Disable SMBv1. https://support.microsoft.com/en-us/help/2696547
Apply following signatures/rules at IDS/IPS

alert tcp $HOME_NET 445 -> any any (msg:"ET EXPLOIT Possible ETERNALBLUE MS17-010 Echo Response"; flow:from_server,established; content:"|00 00 00 31 ff|SMB|2b 00 00 00 00 98 07 c0|"; depth:16; fast_pattern; content:"|4a 6c 4a 6d 49 68 43 6c 42 73 72 00|"; distance:0; flowbits:isset,ETPRO.ETERNALBLUE; classtype:trojan-activity; sid:2024218; rev:2;)

(http://docs.emergingthreats.net/bin/view/Main/2024218)

alert smb any any -> $HOME_NET any (msg:"ET EXPLOIT Possible ETERNALBLUE MS17-010 Echo Request (set)"; flow:to_server,established; content:"|00 00 00 31 ff|SMB|2b 00 00 00 00 18 07 c0|"; depth:16; fast_pattern; content:"|4a 6c 4a 6d 49 68 43 6c 42 73 72 00|"; distance:0; flowbits:set,ETPRO.ETERNALBLUE; flowbits:noalert; classtype:trojan-activity; sid:2024220; rev:1;)

alert smb $HOME_NET any -> any any (msg:"ET EXPLOIT Possible ETERNALBLUE MS17-010 Echo Response"; flow:from_server,established; content:"|00 00 00 31 ff|SMB|2b 00 00 00 00 98 07 c0|"; depth:16; fast_pattern; content:"|4a 6c 4a 6d 49 68 43 6c 42 73 72 00|"; distance:0; flowbits:isset,ETPRO.ETERNALBLUE; classtype:trojan-activity; sid:2024218; rev:1;)


Countermeasures:
Block SMB ports on Enterprise Edge/perimeter network devices [UDP 137, 138 and TCP 139, 445] or Disable SMBv1. SMB ports should not be visible over public network.Perform regular backups of all critical information to limit the impact of data or system loss and to help expedite the recovery process. Ideally, this data should be kept on a separate device, and backups should be stored offline.Establish a Sender Policy Framework (SPF), Domain Message Authentication Reporting and Conformance (DMARC), and DomainKeys Identified Mail (DKIM) for your domain, which is an email validation system designed to prevent spam by detecting email spoofing.Don't open attachments in unsolicited e-mails, even if they come from people in your contact list, and never click on a URL contained in an unsolicited e-mail, even if the link seems benign. In cases of genuine URLs close out the e-mail and go to the organization's website directly through browserRestrict execution of PowerShell /WSCRIPT in enterprise environment Ensure installation and use of the latest version (currently v5.0) of PowerShell, with enhanced logging enabled. Script block logging, and transcription enabled. Send the associated logs to a centralized log repository for monitoring and analysis.Application whitelisting/Strict implementation of Software Restriction Policies (SRP) to block binaries running from %APPDATA%, %PROGRAMDATA% and %TEMP% paths. Malware sample drops and executes generally from these locations. Enforce application whitelisting on all endpoint workstations.Deploy web and email filters on the network. Configure these devices to scan for known bad domains, sources, and addresses; block these before receiving and downloading messages. Scan all emails, attachments, and downloads both on the host and at the mail gateway with a reputable antivirus solution.Disable macros in Microsoft Office products. Some Office products allow for the disabling of macros that originate from outside of an organization and can provide a hybrid approach when the organization depends on the legitimate use of macros. For Windows, specific settings can block macros originating from the Internet from running.Configure access controls including file, directory, and network share permissions with least privilege in mind. If a user only needs to read specific files, they should not have write access to those files, directories, or shares.Maintain updated Antivirus software on all systemsConsider installing Enhanced Mitigation Experience Toolkit, or similar host-level anti-exploitation tools.Block the attachments of file types, exe|pif|tmp|url|vb|vbe|scr|reg|cer|pst|cmd|com|bat|dll|dat|hlp|hta|js|wsfKeep the operating system third party applications (MS office, browsers, browser Plugins) up-to-date with the latest patches.Follow safe practices when browsing the web. Ensure the web browsers are secured enough with appropriate content controls.Network segmentation and segregation into security zones - help protect sensitive information and critical services. Separate administrative network from business processes with physical controls and Virtual Local Area Networks.Disable remote Desktop Connections, employ least-privileged accounts.Ensure integrity of the codes /scripts being used in database, authentication and sensitive systems, Check regularly for the integrity of the information stored in the databases.Restrict users' abilities (permissions) to install and run unwanted software applications.Enable personal firewalls on workstations.Implement strict External Device (USB drive) usage policy.Employ data-at-rest and data-in-transit encryption.Carry out vulnerability Assessment and Penetration Testing (VAPT) and information security audit of critical networks/systems, especially database servers from CERT-IN empaneled auditors. Repeat audits at regular intervals.Individuals or organizations are not encouraged to pay the ransom, as this does not guarantee files will be released. Report such instances of fraud to CERT-In and Law Enforcement agencies

========================================
WannaCry”s 15 minutes of fame has allowed an older piece of malware, based on the same EternalBlue exploit, to fly under the radar. The newly reported malware, dubbed Adylkuzz, carries a cryptocurrency miner that steals endpoint computing power to make virtual â€“ but nonetheless real â€“ money for its author.

The large-scale attack, said to have easily infected more endpoints that WannaCry, predates the widely publicized ransomware threat by more than a week. Bitdefender confirmed the findings of security firm Proofpoint today, showing that Adylkuzz:

uses the same EternalBlue exploit as WannaCry (alongside the NSA backdoor called DoublePulsar)
packs a Trojan horse containing a Monero (electronic currency similar to Bitcoin) mining tool
blocks Microsoft Server Message Block (SMB) on TCP port 445 ensuring persistency on the victim”s computer
Here”s the irony, though: because it exploits the same vulnerability as the WannaCry ransomware, and because it blocks the vulnerable 445 port, Adylkuzz is actually helping reduce the number of WannaCry infections out there.

Implications
The cryptocurrency mining tool that makes up Adylkuzz”s payload has one mission only: to use your computer”s resources to generate cybercash for the attackers.

“While an individual laptop may generate only a few dollars per week, collectively the network of compromised computers appears to be generating five-figure payouts daily,” Proofpoint”s Robert Holmes told The Mirror.

On May 15, when the company first identified the threat, more than $40,000 had been mined and deposited at different Monero addresses (e-wallets).

The emergence of Adylkuzz strengthens Bitdefender’s warning that various groups of attackers will continue to exploit the MS17-010 vulnerability until all Windows users have installed the necessary patches.

How to tell if you”re infected
Because of its stealthy nature, Adylkuzz is hard to detect without a dedicated anti-malware solution. The only thing you”ll (probably) notice is a sudden slowdown in your PC”s performance. This is because mining virtual money is CPU-intensive.

However, few users will correlate such behavior with actual malware and, without an AV program installed, there is no way to find the Trojan and eradicate it.

How to disinfect your computer
1. Like with the WannaCry malware, your first order of business is to patch Windows. Simply allow your Windows operating system to download the latest updates, or you can manually grab the patch from the Microsoft Update Catalog for your respective Windows version.

2. Consider installing a reputable anti-malware solution. This will not only prevent such attacks in the future, but it will also remove the (now useless) Adylkuzz infection from your system. Bitdefender customers are pro-actively protected against such attacks through its Active Threat Control technology that leverages machine learning.

=======================
When the ShadowBrokers first published the code for EternalBlue — an NSA exploit targeting Windows’ file-sharing protocol — researchers knew it was a bad bug. But most had no idea of the scale of the damage that would be caused by the vulnerability.

Much of that damage has only become visible in recent days, as a ransomware program dubbed “WannaCry” locked up computers from the UK’s National Health Service to the Russian Ministry of the Interior. Some of the damage caused by EternalBlue was harder to spot, caused by more discreet malware designed to infect and monetize computers without leaving a trace. As researchers look for clues as to WannaCry’s origins, more of those programs are coming to light, and giving us more information about the sheer scale of the damage caused by Eternal Blue.

A $43,000 cryptocurrency scheme

One of those programs, called Adylkuzz, exploits the vulnerability to mine an obscure cryptocurrency called Monero. According to research released this week by Proofpoint, Adylkuzz became active sometime between April 24th and May 2nd, weeks before WannaCry burst onto the scene. Researchers estimate it reached hundreds of thousands of devices, spreading through the same Windows vulnerability exploited by WannaCry.

Adylkuzz didn’t cause the same stir because it wasn’t shutting down computers or sending ransom notes — all the program did was perform Monero’s mining operation in the background. While that’s definitely not good for your computer, it’s not catastrophic enough to raise alarms, allowing the program to remain undetected until the WannaCry fiasco drew more attention. In fact, because Adylkuzz closed the EternalBlue vulnerability once it infected a machine, researchers suspect the program actually limited the spread of the more damaging ransomware.

Despite the low profile, Adylkuzz was nearly as profitable as WannaCry. Proofpoint identified at least $43,000 paid out as part of the scheme, and it’s likely other wallets would raise the figure even further. So far, roughly $80,000 has been paid out to known WannaCry wallets, a surprisingly low figure given the chaos caused by the attacks. At least one other EternalBlue-powered cryptocurrency miner has been spotted in the wild, and there may be others that are yet undiscovered.

“WannaCry burned the match for EternalBlue.”

There has also been an explosion of WannaCry variants, possibly the work of copycats. Researchers located a kill-switch domain over the weekend that blocked the initial attack, but in the days since, a handful of alternate versions of the ransomware have popped up either pointing to new domains or with no kill-switch protocol at all. But researchers are split on the origin of the variants, with some pointing to code corruption issues as evidence of a third party at work.

Earlier today, researchers at TrendMicro announced the discovery of an entirely new variant called UIWIX. Like WannaCry, it’s a ransomware program built on EternalBlue — but UIWIX is able to infect machines without writing files to permanent storage, making it far harder to detect through conventional forensics. It also adds new methods to throw off researchers observing it in a virtual environment, leading TrendMicro to suspect a separate group is responsible for the new attack.

That combination of new and old variants make it harder to definitively say who was responsible for the initial WannaCry infections, as it grows increasingly likely that multiple actors are in play. The question has become particularly urgent after Symantec and Kaspersky announced evidence tying the initial attack to a previously researched North Korean cybercrime group.

The good news: patching the single vulnerability will protect against all the different variants, particularly now that Microsoft has released its emergency XP patch. As a result, some researchers see WannaCry’s sudden fame as a powerful weapon against the lesser-known bugs. “I think that WannaCry caused a few cybercriminals to accelerate their timelines,” said Trend Micro cloud research VP Mark Ninnukhoven. “WannaCry burned the match for EternalBlue. For defenders this is a really good thing as WannaCry — which did cause some real-world damage and has frustrated organizations worldwide — wasn’t nearly as malicious as other malware and ransomware that we’ve seen previously.”


================================
Fileless malware can be a difficult threat to analyze and detect. It shouldn’t be a surprise that an increasing number of new malware threats are fileless, as threat actors use this technique to make both detection and forensic investigation more difficult. We recently found a new cryptocurrency miner (which we detect as TROJ64_COINMINER.QO) that uses this particular technique as well.

We first saw this particular variant affecting the Asia-Pacific region in July. Feedback data from the Smart Protection Network (SPN) shows the countries in the region most affected by this threat. Of the five most affected countries, only the United States (fourth most affected, with approximately 8% of the global tally) was outside of the Asia-Pacific region.

wmi1b

Figure 1. Distribution of TROJ64_COINMINER.QO infections in the APAC region from July to August 2017

This threat uses WMI (Windows Management Instrumentation) as its fileless persistence mechanism. Specifically, it used the WMI Standard Event Consumer scripting application (scrcons.exe) to execute its scripts. To enter a system, the malware uses the EternalBlue vulnerability – MS17-010. The combination of fileless WMI scripts and EternalBlue makes this threat extremely stealthy and persistent.

Arrival and Installation

The infection flow of this cryptocurrency miner malware has several stages. The infection flow starts with MS17-010; the vulnerability is used to drop and run a backdoor on the system (BKDR_FORSHARE.A), which installs various WMI scripts. These scripts then connect to its C&C servers to get instructions and download the cryptocurrency miner malware together with its components.

wmi2

Figure 2. Infection flow

Use of WMI for persistence

WMI is a core component of Windows, which is commonly used for day-to-day management tasks such as deploying automation scripts, running a process/program on a given time, get information about the installed applications or hardware, monitor for changes in a folder, and monitor disk space, among others. However, in the hands of a cybercriminal, this can be used maliciously, as discussed in our paper titled Understanding WMI Malware. The techniques used here are very similar to those used by the sample discussed in the paper, which we detect as TROJ_WMIGHOST.A.

The following root/subscription classes are used to trigger the malicious WMI script when certain conditions are met:

ActiveScriptEventConsumer
__EventFilter
__IntervalTimerInstruction
__AbsoluteTimerInstruction
__FilterToConsumerBinding
The malicious WMI script can be found in an instance of the ActiveScriptEventConsumer class under the ROOT\subscription namespace. ActiveScriptEventConsumer is the persistence payload, which contains the instructions to execute when a condition is met. For this example, it contains the malicious JScript that will be executed when the condition is met.

wmi3

Figure 3. ActiveScriptEventConsumer-class malicious JScript

Extracting the JScript from ActiveScriptEventConsumer class reveals the following scripts:

wmi4

Figure 4. Malicious JScript found in ActiveScriptEventConsumer class

Analyzing the JScript revealed that the threat actors used multiple layers of C&C servers, allowing threat actors to update the appropriate servers and components used quickly. This will change the downloaded malicious files and allow attackers to avoid detection.

The first-stage C&C server located at hxxp://wmi[.]mykings[.]top:8888/test[.]html contains instructions on where to download the cryptocurrency miner and its components. This also contains the addresses of the second- and third-stage C&C servers. Our monitoring of the above URL shows that the operation is still active. As noted on the infection diagram, the actual coin-mining payload is downloaded by TROJ_COINMINER.AUSWQ. This was first hosted at hxxp://67[.]21[.]90[.]226:8888/32.zip, as seen from the contents of the URL:

wmi5

Figure 5. Initial contents of first-stage C&C server

Recently, this URL was updated to change the target URL, although the file downloaded remained identical.

wmi6

Figure 6. Later contents of C&C server

This indicates that this operation is still active since the responsible threat actors are still monitoring and updating their C&C servers. The __EventFilter class holds the condition to trigger the event. Viewing the __EventFilter class, it contains the WQL query Select * from __timerevent where timerid = “fuckyoumm2_itimer”. This query looks for the timer ID named “fuckyoumm2_itimer”.

wmi7tb

Figure 7. __EventFilter condition

The __IntervalTimerInstruction class exposes two properties: TimerID and IntervalBetweenEvents. The TimerID contains the unique name for the instance “fuckyoumm2_itimer”, which the __EventFilter condition is pointing to. The IntervalBetweenEvents provides the trigger time of the malicious WMI script. The IntervalBetweenEvents property is expressed in milliseconds. For this example, it shows that the interval is 10800000 milliseconds, or 180 minutes (3 hours). This means that the malicious WMI script will be triggered every 3 hours.

wmi8tb

Figure 8. __IntervalTimerInstruction time interval trigger

Additional information can also be found under __AbsoluteTimerInstruction. This class causes an event to be generated on a specific date at a specific time.

wmi9tb

Figure 9.  __AbsoluteTimerInstruction information

Finally, in order for all of the classes and instances to connect to each other, the registration to __FilterToConsumerBinding is needed. The following information was found under the __FilterToConsumerBinding class.

ActiveScriptEventConsumer.Name=fuckyoumm2_consumer __EventFilter.Name="fuckyoumm2_filter"
wmi10

Figure 10. Full __FilterToConsumerBinding registration

__FilterToConsumerBinding class associates __EventFilter instance with __ActiveScriptEventConsumer instance. It completes the cycle by relating the class instances with each other. It checks what Windows event in __EventFilter will be executed together with the script in __ActiveScriptEventConsumer.”

Best Practices

There are two areas where IT administrators can learn from this attack and improve their defenses.

First, restrict (and disable) WMI as needed. It requires administrator rights to be used on a system. Granting access only to specific groups of administrator accounts that need to use WMI would help reduce risk of WMI attacks.

Not all machines require the WMI service. If a machine does not need access to WMI, disable it to eliminate the risk. Microsoft provides a quick guide on how to stop WMI service completely. Microsoft also provides a tool that can trace WMI activity. SMBv1 can also be disabled to reduce the risk to users.

The entry point of this attack was EternalBlue, for which a patch has been available since March 2017. However, there are still a lot of machines exposed to this vulnerability.  Ensuring that the operating system, software, and other applications are updated with the latest patches deters threats from using security gaps as their doorways into systems and networks.

Conclusion

Fileless attacks are becoming more common. Threat actors are increasingly using attack methods that work directly from memory and use legitimate tools or services. In this case, WMI subscriptions have been used by this cryptocurrency-mining malware as its fileless persistence mechanism. Since there are no malware files on the hard drive, it's more difficult to detect.

In today’s threat landscape, searching the hard drive for malicious files is no longer enough. Looking for evidence in memory is also difficult, especially if the attack has certain conditions before it runs. Usually, you end up capturing the systems memory without triggering the malicious activity. There are, however, huge libraries of Windows artifacts that may provide clues for an investigation such as shimcache, muicache, or prefetch. Configuring Windows event logs to monitor system activity can also provide additional useful information.

Trend Micro Solutions

Email and web gateway solutions such as Trend Micro™ Deep Discovery™ Email Inspector and InterScan™ Web Security can prevent malware from ever reaching end users. At the endpoint level, Trend Micro Smart Protection Suites deliver several capabilities like high fidelity machine learning, web reputation services, behavior monitoring, and application control, and vulnerability shielding that minimize the impact of this threat. Trend Micro Endpoint Sensor will also be effective in monitoring events related to WMI, this product will help quickly examine what processes or events are triggering the malicious activity.

Trend Micro™ Deep Discovery™ Inspector can detect connections to malicious C&C and help quickly identify the impacted machines on networks, while Trend Micro™ Deep Security™ can stop MS17-010 exploits from the network through its IPS technology.

For small businesses, Trend Micro Worry-Free Services Advanced offers cloud-based email gateway security through Hosted Email Security. Its endpoint protection also delivers several capabilities such as behavior monitoring and real-time web reputation in order detect and block ransomware.